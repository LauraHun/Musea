<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic User Profile - Adaptive Museum Explorer</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script>(function(){try{if(localStorage.getItem('dark_mode')==='1')document.documentElement.classList.add('dark-mode');}catch(e){}})();</script>
    <style>
        .profile-container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 30px;
        }
        .profile-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .profile-section h2 {
            color: #8A734D;
            margin-bottom: 20px;
            font-size: 24px;
        }
        .engagement-score {
            font-size: 48px;
            font-weight: 700;
            color: #8A734D;
            text-align: center;
            margin: 20px 0;
        }
        .theme-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 15px;
        }
        .theme-item {
            background: #FDFBF5;
            border: 2px solid #8A734D;
            border-radius: 8px;
            padding: 15px;
        }
        .theme-name {
            font-weight: 600;
            color: #8A734D;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        .theme-score {
            font-size: 24px;
            font-weight: 700;
            color: #B89F70;
            min-width: 50px;
            text-align: right;
        }
        .museum-popularity {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .museum-pop-item {
            background: #FDFBF5;
            border-left: 4px solid #8A734D;
            padding: 15px;
            border-radius: 4px;
        }
        .museum-pop-item strong {
            color: #8A734D;
        }
        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #8A734D;
            text-decoration: none;
            font-weight: 500;
        }
        .back-link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="top-bar">
        <div class="top-bar-left">
            <button class="nav-toggle" id="navToggle" aria-label="Toggle navigation">
                <i class="fas fa-bars"></i>
            </button>
            <a href="{{ url_for('museum_gallery') }}" style="text-decoration: none; color: inherit;">
                <div class="logo-container" style="cursor: pointer;">
                    <span class="logo-text">Musea</span>
                </div>
            </a>
            <nav class="main-nav">
                <a href="{{ url_for('museum_gallery') }}" class="nav-item" data-en="Home" data-fr="Accueil">Home</a>
                <a href="{{ url_for('favorites') }}" class="nav-item" data-en="Favorites" data-fr="Favoris">Favorites</a>
                <a href="{{ url_for('history') }}" class="nav-item" data-en="History" data-fr="Historique">History</a>
                <a href="{{ url_for('view_user_profile') }}" class="nav-item active" data-en="Dashboard" data-fr="Tableau de bord">Dashboard</a>
            </nav>
        </div>
        <div class="top-bar-right">
            <button class="dark-mode-btn" id="darkModeBtn" aria-label="Switch to dark mode" title="Dark mode">
                <i class="fas fa-moon"></i>
            </button>
            <div class="language-switcher">
                <button class="language-btn" id="languageBtn" aria-label="Change language">
                    <i class="fas fa-globe"></i>
                    <span id="currentLang">EN</span>
                </button>
                <div class="language-dropdown" id="languageDropdown">
                    <button class="lang-option" data-lang="en">English</button>
                    <button class="lang-option" data-lang="fr">Français</button>
                </div>
            </div>
            <div class="profile-switcher">
                <button class="profile-btn" id="profileBtn" aria-label="Profile menu">
                    <i class="fas fa-user-circle"></i>
                </button>
                <div class="profile-dropdown" id="profileDropdown">
                    <a href="{{ url_for('view_user_profile') }}" class="profile-option">
                        <i class="fas fa-user"></i>
                        <span data-en="My profile" data-fr="Mon profil">My profile</span>
                    </a>
                    <a href="{{ url_for('profile_edit') }}" class="profile-option">
                        <i class="fas fa-edit"></i>
                        <span data-en="Edit interests & distance" data-fr="Modifier intérêts et distance">Edit interests & distance</span>
                    </a>
                    <a href="{{ url_for('logout') }}" class="profile-option logout">
                        <i class="fas fa-sign-out-alt"></i>
                        <span data-en="Logout" data-fr="Déconnexion">Logout</span>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="profile-container">
            <a href="{{ url_for('museum_gallery') }}" class="back-link">
                <i class="fas fa-arrow-left"></i> <span data-en="Back to Gallery" data-fr="Retour à la galerie">Back to Gallery</span>
            </a>

            <h1 style="color: #8A734D; margin-bottom: 30px;" data-en="User Dashboard" data-fr="Tableau de bord utilisateur">User Dashboard</h1>

            <!-- Engagement Analytics Dashboard -->
            <div class="profile-section" style="background: linear-gradient(135deg, #8A734D 0%, #B89F70 100%); color: white; padding: 30px;">
                <h2 style="color: white; margin-bottom: 20px;" data-en="Engagement Analytics" data-fr="Analyses d'engagement">Engagement Analytics</h2>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;">
                    <div style="background: rgba(255, 255, 255, 0.2); padding: 20px; border-radius: 12px; backdrop-filter: blur(10px);">
                        <div style="font-size: 36px; font-weight: 700; margin-bottom: 5px;">{{ dynamic_profile.engagement_score }}</div>
                        <div style="font-size: 0.9em; opacity: 0.9;" data-en="Total Points" data-fr="Points totaux">Total Points</div>
                    </div>
                    <div style="background: rgba(255, 255, 255, 0.2); padding: 20px; border-radius: 12px; backdrop-filter: blur(10px);">
                        <div style="font-size: 36px; font-weight: 700; margin-bottom: 5px; color: {{ engagement_color }};">{{ engagement_level }}</div>
                        <div style="font-size: 0.9em; opacity: 0.9;" data-en="Engagement Level" data-fr="Niveau d'engagement">Engagement Level</div>
                    </div>
                    <div style="background: rgba(255, 255, 255, 0.2); padding: 20px; border-radius: 12px; backdrop-filter: blur(10px);">
                        <div style="font-size: 36px; font-weight: 700; margin-bottom: 5px;">{{ theme_count }}</div>
                        <div style="font-size: 0.9em; opacity: 0.9;" data-en="Active Themes" data-fr="Thèmes actifs">Active Themes</div>
                    </div>
                    <div style="background: rgba(255, 255, 255, 0.2); padding: 20px; border-radius: 12px; backdrop-filter: blur(10px);">
                        <div style="font-size: 36px; font-weight: 700; margin-bottom: 5px;">{{ total_interactions }}</div>
                        <div style="font-size: 0.9em; opacity: 0.9;" data-en="Total Interactions" data-fr="Interactions totales">Total Interactions</div>
                    </div>
                </div>
            </div>

            <!-- Theme Affinities as donut-style gauges -->
            <div class="profile-section">
                <h2 data-en="Theme Affinities" data-fr="Affinités thématiques">Theme Affinities</h2>
                {% if dynamic_profile.theme_affinities %}
                    {% set total_points = dynamic_profile.theme_affinities.values() | sum %}
                    {# Soft, pretty pastel-like colors that still match Musea's warm palette #}
                    {% set donut_colors = ['#B89F70', '#C08457', '#A1B56C', '#79A6D2', '#C58BB5', '#8A734D'] %}
                    <div class="theme-gauges">
                        {% for theme, score in dynamic_profile.theme_affinities.items() %}
                        {% set percent_raw = (score / total_points * 100) if total_points > 0 else 0 %}
                        {% set percent = percent_raw | round(0, 'common') %}
                        {% set color = donut_colors[loop.index0 % donut_colors|length] %}
                        <div class="theme-gauge-donut">
                            <div class="donut" style="--percent: {{ percent_raw }}; --donut-color: {{ color }};">
                                <span class="donut-value">{{ percent }}%</span>
                            </div>
                            <div class="donut-label">{{ theme }}</div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p style="color: #666; text-align: center; padding: 40px;" data-en="No theme interactions yet. Start exploring museums!" data-fr="Aucune interaction thématique pour le moment. Commencez à explorer les musées!">No theme interactions yet. Start exploring museums!</p>
                {% endif %}
            </div>

            <!-- Onboarding Info (Compact) -->
            {% if onboarding_profile %}
            <div class="profile-section">
                <h2 data-en="Profile Information" data-fr="Informations du profil">Profile Information</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 15px;">
                    <div>
                        <strong data-en="Language" data-fr="Langue">Language:</strong>
                        <p>{{ onboarding_profile['ui_language'] }}</p>
                    </div>
                    <div>
                        <strong data-en="Visitor Type" data-fr="Type de visiteur">Visitor Type:</strong>
                        <p>{{ onboarding_profile['visitor_type'] }}</p>
                    </div>
                    <div>
                        <strong data-en="Distance Preference" data-fr="Préférence de distance">Distance Preference:</strong>
                        <p>{{ onboarding_profile['distance_pref'] }}</p>
                    </div>
                    <div>
                        <strong data-en="Interest Mode" data-fr="Mode d'intérêt">Interest Mode:</strong>
                        <p>{{ onboarding_profile['interest_mode'] }}</p>
                    </div>
                </div>
                {% if themes %}
                <div style="margin-top: 20px;">
                    <strong data-en="Preferred Themes" data-fr="Thèmes préférés">Preferred Themes:</strong>
                    <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;">
                        {% for theme in themes %}
                        <span style="background: #F5E6D3; padding: 5px 15px; border-radius: 20px; color: #8A734D;">{{ theme }}</span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
            {% endif %}

            <!-- Explainability Section: Why am I seeing this? -->
            <div class="profile-section" style="background: #FDFBF5; border: 2px solid #8A734D;">
                <h2 style="color: #8A734D; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-question-circle"></i>
                    <span data-en="Why am I seeing this?" data-fr="Pourquoi je vois cela ?">Why am I seeing this?</span>
                </h2>
                <p style="color: #666; margin-bottom: 20px;" data-en="This section explains how the system adapts to your context and preferences." data-fr="Cette section explique comment le système s'adapte à votre contexte et à vos préférences.">This section explains how the system adapts to your context and preferences.</p>
                
                <div style="display: grid; gap: 15px;">
                    <!-- Current Context -->
                    <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #8A734D;">
                        <strong style="color: #8A734D;" data-en="Current Context" data-fr="Contexte actuel">Current Context:</strong>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 10px;">
                            <div>
                                <span style="color: #666;" data-en="Device:" data-fr="Appareil :">Device:</span>
                                <strong style="color: #8A734D; text-transform: capitalize;">{{ context.device }}</strong>
                            </div>
                            <div>
                                <span style="color: #666;" data-en="Connection:" data-fr="Connexion :">Connection:</span>
                                <strong style="color: #8A734D; text-transform: capitalize;">{{ context.connection_quality }}</strong>
                            </div>
                            <div>
                                <span style="color: #666;" data-en="Time Available:" data-fr="Temps disponible :">Time Available:</span>
                                <strong style="color: #8A734D;">{{ context.time_available }} min</strong>
                            </div>
                        </div>
                    </div>

                    <!-- Active Adaptations -->
                    {% if active_settings.adaptation_reasons %}
                    <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #B89F70;">
                        <strong style="color: #8A734D;" data-en="Active Adaptations" data-fr="Adaptations actives">Active Adaptations:</strong>
                        <ul style="margin-top: 10px; padding-left: 20px; color: #666;">
                            {% if not active_settings.show_images %}
                            <li data-en="Images are hidden to save bandwidth on poor connection" data-fr="Les images sont masquées pour économiser la bande passante sur une connexion faible">Images are hidden to save bandwidth on poor connection</li>
                            {% endif %}
                            {% if active_settings.description_length == 'short' %}
                            <li data-en="Descriptions are shortened because you have limited time ({{ context.time_available }} minutes)" data-fr="Les descriptions sont raccourcies car vous avez un temps limité ({{ context.time_available }} minutes)">Descriptions are shortened because you have limited time ({{ context.time_available }} minutes)</li>
                            {% endif %}
                            {% if active_settings.max_results < 12 %}
                            <li data-en="Showing {{ active_settings.max_results }} results instead of 12 to match your available time" data-fr="Affichage de {{ active_settings.max_results }} résultats au lieu de 12 pour correspondre à votre temps disponible">Showing {{ active_settings.max_results }} results instead of 12 to match your available time</li>
                            {% endif %}
                            {% if active_settings.layout == 'list' %}
                            <li data-en="Using list layout optimized for mobile devices" data-fr="Utilisation de la mise en page en liste optimisée pour les appareils mobiles">Using list layout optimized for mobile devices</li>
                            {% endif %}
                        </ul>
                    </div>
                    {% else %}
                    <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #27ae60;">
                        <strong style="color: #8A734D;" data-en="No Adaptations Active" data-fr="Aucune adaptation active">No Adaptations Active</strong>
                        <p style="color: #666; margin-top: 10px;" data-en="You're seeing the optimal experience. All features are enabled with full content." data-fr="Vous bénéficiez de l'expérience optimale. Toutes les fonctionnalités sont activées avec le contenu complet.">You're seeing the optimal experience. All features are enabled with full content.</p>
                    </div>
                    {% endif %}

                    <!-- Adaptation Rules Explanation -->
                    <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #8A734D;">
                        <strong style="color: #8A734D;" data-en="How Adaptations Work" data-fr="Comment fonctionnent les adaptations">How Adaptations Work:</strong>
                        <div style="margin-top: 10px; color: #666; font-size: 0.9em;">
                            <p data-en="The system automatically adjusts the interface based on:" data-fr="Le système ajuste automatiquement l'interface en fonction de :">The system automatically adjusts the interface based on:</p>
                            <ul style="margin-top: 8px; padding-left: 20px;">
                                <li data-en="Your connection quality (poor = images hidden)" data-fr="La qualité de votre connexion (faible = images masquées)">Your connection quality (poor = images hidden)</li>
                                <li data-en="Available time (≤15 min = fewer results, shorter descriptions)" data-fr="Temps disponible (≤15 min = moins de résultats, descriptions plus courtes)">Available time (≤15 min = fewer results, shorter descriptions)</li>
                                <li data-en="Device type (mobile = list layout, optimized display)" data-fr="Type d'appareil (mobile = mise en page en liste, affichage optimisé)">Device type (mobile = list layout, optimized display)</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Museum Popularity -->
            <div class="profile-section">
                <h2 data-en="Most Popular Museums (Global)" data-fr="Musées les plus populaires (Global)">Most Popular Museums (Global)</h2>
                {% if museum_stats %}
                    <div class="museum-popularity">
                        {% for museum in museum_stats %}
                        <div class="museum-pop-item">
                            <strong data-en="Museum" data-fr="Musée">Museum</strong> {{ museum.name or museum.museum_id }}<br>
                            <strong data-en="Theme" data-fr="Thème">Theme:</strong> {{ museum.theme }}<br>
                            <strong data-en="Popularity" data-fr="Popularité">Popularity:</strong> {{ museum.popularity_score }} <span data-en="points" data-fr="points">points</span>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p style="color: #666;" data-en="No museums in the database yet." data-fr="Aucun musée dans la base pour l'instant.">No museums in the database yet.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/dark-mode.js') }}"></script>
    <script>
        // Language switcher functionality
        const languageBtn = document.getElementById('languageBtn');
        const languageDropdown = document.getElementById('languageDropdown');
        const currentLangSpan = document.getElementById('currentLang');
        let currentLanguage = sessionStorage.getItem('preferred_language') || 'en';
        
        function updatePageLanguage(lang) {
            currentLanguage = lang;
            document.documentElement.lang = lang;
            if (currentLangSpan) {
                currentLangSpan.textContent = lang.toUpperCase();
            }
            sessionStorage.setItem('preferred_language', lang);
        }
        
        updatePageLanguage(currentLanguage);

        if (languageBtn && languageDropdown) {
            languageBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                languageDropdown.classList.toggle('show');
            });

            document.addEventListener('click', function(e) {
                if (!languageBtn.contains(e.target) && !languageDropdown.contains(e.target)) {
                    languageDropdown.classList.remove('show');
                }
            });

            document.querySelectorAll('.lang-option').forEach(option => {
                option.addEventListener('click', function() {
                    const lang = this.getAttribute('data-lang');
                    updatePageLanguage(lang);
                    languageDropdown.classList.remove('show');
                });
            });
        }

        // Profile dropdown functionality
        const profileBtn = document.getElementById('profileBtn');
        const profileDropdown = document.getElementById('profileDropdown');
        
        if (profileBtn && profileDropdown) {
            profileBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                profileDropdown.classList.toggle('show');
                if (languageDropdown) languageDropdown.classList.remove('show');
            });

            document.addEventListener('click', function(e) {
                if (!profileBtn.contains(e.target) && !profileDropdown.contains(e.target)) {
                    profileDropdown.classList.remove('show');
                }
            });
        }
    </script>
</body>
</html>
